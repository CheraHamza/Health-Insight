{% extends "base.html" %}
{% block content %}
<div class="mb-6 flex items-center justify-between">
  <a href="/" class="text-emerald-600 hover:underline">
    <i class="fas fa-arrow-left mr-1"></i> Back
  </a>
  <h1 class="text-2xl font-bold text-gray-800">All Alerts</h1>
  <div class="text-xs text-gray-500">Updates every 10s</div>
</div>

<div class="bg-white rounded-2xl shadow-lg p-6 border-t-4 border-red-500">
  <div id="alerts-empty" class="text-sm text-gray-500 {% if alerts and alerts|length > 0 %}hidden{% endif %}">No alerts found.</div>

  <div id="alerts-list" class="space-y-2 {% if not alerts or alerts|length == 0 %}hidden{% endif %}">
    {% if alerts and alerts|length > 0 %}
    {% for a in alerts %}
    <div class="flex items-start justify-between gap-4 bg-red-50 border border-red-100 rounded-xl px-4 py-3">
      <div>
        <div class="text-sm font-semibold text-red-700">
          {{ a.alert_type }} ·
          {{ a.patient_id }}
        </div>
        <div class="text-xs text-gray-600 mt-0.5">
          {{ a.metric_name|replace('_', ' ') }}:
          {{ a.observed_value }}
        </div>
      </div>
      <div class="text-right">
        <div class="text-xs font-mono text-gray-600">
          {{ a.timestamp }}
        </div>
        <a href="{{ url_for('patient_detail', patient_id=a.patient_id) }}" class="text-xs text-emerald-700 hover:underline">View patient</a>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>
</div>

<script>
  async function refreshAllAlerts() {
    try {
      const res = await fetch('/api/alerts/recent?limit=200&since_minutes=1440', {
        cache: 'no-store'
      });
      if (!res.ok) return;
      const alerts = await res.json();

      const list = document.getElementById('alerts-list');
      const empty = document.getElementById('alerts-empty');

      if (!Array.isArray(alerts) || alerts.length === 0) {
        list.innerHTML = '';
        list.classList.add('hidden');
        empty.classList.remove('hidden');
        return;
      }

      empty.classList.add('hidden');
      list.classList.remove('hidden');
      list.innerHTML = alerts.map(a => {
        const patientId = a.patient_id || '';
        const alertType = a.alert_type || 'ALERT';
        const metricName = (a.metric_name || '').replaceAll('_', ' ');
        const observed = (a.observed_value ?? '');
        const ts = a.timestamp || '';
        const patientUrl = '/patient/' + encodeURIComponent(patientId);

        return (
          '<div class="flex items-start justify-between gap-4 bg-red-50 border border-red-100 rounded-xl px-4 py-3">' +
          '<div>' +
          '<div class="text-sm font-semibold text-red-700">' + alertType + ' · ' + patientId + '</div>' +
          '<div class="text-xs text-gray-600 mt-0.5">' + metricName + ': ' + observed + '</div>' +
          '</div>' +
          '<div class="text-right">' +
          '<div class="text-xs font-mono text-gray-600">' + ts + '</div>' +
          '<a href="' + patientUrl + '" class="text-xs text-emerald-700 hover:underline">View patient</a>' +
          '</div>' +
          '</div>'
        );
      }).join('');
    } catch (e) {
      // ignore transient errors
    }
  }

  refreshAllAlerts();
  setInterval(refreshAllAlerts, 10000);
</script>
{% endblock %}